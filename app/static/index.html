<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokédex</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Fredoka+One:wght@400&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3B4CCA;
            --primary-gradient: linear-gradient(135deg, #3B4CCA 0%, #5A6EF0 100%);
            --secondary-color: #FFDE00;
            --accent-color: #CC0000;
            --light-color: #f8fafc;
            --dark-color: #1e293b;
            --font-family: 'Nunito', sans-serif;
            --cartoon-font: 'Fredoka One', cursive;
            --card-shadow: 0 10px 25px rgba(59, 76, 202, 0.1);
            --hover-shadow: 0 20px 40px rgba(59, 76, 202, 0.2);
            --border-radius: 20px;
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- Global Styles & Resets --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--light-color) 0%, #e2e8f0 100%);
            color: var(--dark-color);
            line-height: 1.6;
            transition: var(--transition);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            padding: 0 20px;
        }

        button {
            font-family: var(--font-family);
            font-weight: 700;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        /* --- Navbar --- */
        .navbar {
            background: var(--primary-gradient);
            color: #fff;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(10px);
        }

        .navbar .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar .logo {
            font-family: var(--cartoon-font);
            font-size: 2rem;
            cursor: pointer;
            color: var(--secondary-color);
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            transition: var(--transition);
        }

        .navbar .logo:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 0 20px rgba(255, 222, 0, 0.5));
        }

        .navbar .nav-links {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .navbar .nav-links a, .navbar .nav-links button {
            color: #fff;
            padding: 10px 20px;
            text-decoration: none;
            font-weight: 700;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .navbar .nav-links a:hover, .navbar .nav-links button:hover {
            background: rgba(255, 222, 0, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        /* --- Page Sections --- */
        .page {
            display: none;
            padding: 40px 0;
            animation: fadeIn 0.6s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Landing Page --- */
        #landing-page {
            text-align: center;
            padding: 100px 20px;
            background: radial-gradient(circle at center, rgba(59, 76, 202, 0.05) 0%, transparent 70%);
        }

        #landing-page h1 {
            font-family: var(--cartoon-font);
            font-size: 4rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(59, 76, 202, 0.3);
            animation: pulse 2s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.02); }
        }

        #landing-page p {
            font-size: 1.8rem;
            margin-top: 20px;
            color: var(--dark-color);
            font-weight: 600;
        }

        .catchphrase {
            font-family: var(--cartoon-font);
            font-size: 2.5rem;
            color: var(--secondary-color);
            margin: 30px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* --- Pokédex & Teams Page --- */
        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-header h2 {
            font-family: var(--cartoon-font);
            font-size: 3rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
        }

        .search-bar {
            width: 100%;
            max-width: 500px;
            padding: 15px 25px;
            border-radius: 30px;
            border: 3px solid rgba(59, 76, 202, 0.2);
            margin-top: 20px;
            font-size: 1.1rem;
            font-family: var(--font-family);
            transition: var(--transition);
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(59, 76, 202, 0.1);
            transform: translateY(-2px);
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        /* --- Pokémon & Team Cards --- */
        .card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: var(--transition);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card:not(.team-card) {
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: var(--hover-shadow);
        }

        .card-header {
            padding: 25px;
            text-align: center;
            background: linear-gradient(135deg, rgba(59, 76, 202, 0.1) 0%, rgba(255, 222, 0, 0.1) 100%);
        }

        .card-header h3 {
            margin: 0 0 15px 0;
            font-size: 1.6rem;
            font-weight: 900;
        }

        .card-body {
            padding: 0 25px 25px;
        }

        .card p {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .card p:last-child {
            border-bottom: none;
        }

        .pokemon-type {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            color: #fff;
            margin: 5px;
            text-transform: capitalize;
            font-weight: 700;
            font-size: 0.9rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: var(--transition);
        }

        .pokemon-type:hover {
            transform: scale(1.1);
        }

        /* Team Card Specifics */
        .team-card {
            cursor: pointer;
        }

        .team-preview {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 15px;
            flex-wrap: wrap;
        }

        .team-preview-pokemon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 900;
            font-size: 0.9rem;
            transition: var(--transition);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .team-preview-pokemon:hover {
            transform: scale(1.1);
        }

        .team-pokemons-list {
            display: none;
            padding: 25px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .team-pokemons-list.expanded {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 500px; }
        }

        .card-footer {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            padding: 15px;
            gap: 10px;
        }

        .card-footer button {
            flex: 1;
            background: var(--primary-gradient);
            color: #fff;
            border-radius: 15px;
        }

        .card-footer button.delete {
            background: linear-gradient(135deg, var(--accent-color) 0%, #dc2626 100%);
        }

        .card-footer button:hover {
            transform: translateY(-2px);
        }

        /* --- Modals --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0; 
            top: 0;
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .modal.active {
            display: flex;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 20px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 500px;
            position: relative;
            box-shadow: var(--hover-shadow);
            border: 1px solid rgba(255,255,255,0.2);
            animation: modalSlideUp 0.3s ease-out;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        @keyframes modalSlideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-close {
            position: absolute;
            top: 10px; 
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            border: none;
            background: rgba(204, 0, 0, 0.1);
            color: var(--accent-color);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            z-index: 10;
        }

        .modal-close:hover {
            background: var(--accent-color);
            color: white;
            transform: scale(1.1);
        }

        .modal-content h2 {
            text-align: center;
            margin-bottom: 20px;
            font-family: var(--cartoon-font);
            font-size: 1.8rem;
            color: var(--primary-color);
            flex-shrink: 0;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }

        .modal-form input[type="text"],
        .modal-form input[type="email"],
        .modal-form input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 2px solid rgba(59, 76, 202, 0.2);
            border-radius: 15px;
            font-size: 1rem;
            font-family: var(--font-family);
            transition: var(--transition);
            background: rgba(255,255,255,0.8);
        }

        .modal-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 76, 202, 0.1);
            transform: translateY(-2px);
        }

        .modal-form button[type="submit"] {
            width: 100%;
            background: var(--primary-gradient);
            color: #fff;
            margin-top: 15px;
            padding: 15px;
            font-size: 1.1rem;
            flex-shrink: 0; /* Prevents button from shrinking */
        }

        .form-toggle {
            text-align: center;
            margin-top: 15px;
        }

        .form-toggle a {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
            font-weight: 700;
            transition: var(--transition);
        }

        .form-toggle a:hover {
            color: var(--accent-color);
        }

        /* --- New Team Modal Styles --- */
        #team-modal .modal-content {
            max-width: 95vw;
        }

        .team-builder-layout {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-grow: 1;
            overflow: hidden; /* Important for child scrolling */
        }

        .pokemon-selection-panel {
            flex: 2;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .team-preview-panel {
            flex: 1;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(59, 76, 202, 0.1);
            transition: var(--transition);
        }

        .team-preview-panel h3 {
            font-family: var(--cartoon-font);
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2rem;
        }

        .selector-controls {
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .type-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .type-filters button {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            background: rgba(226, 232, 240, 0.8);
            transition: var(--transition);
            font-weight: 600;
        }

        .type-filters button:hover {
            background: rgba(59, 76, 202, 0.1);
            transform: translateY(-2px);
        }

        .type-filters button.active {
            background: var(--primary-gradient);
            color: #fff;
            box-shadow: 0 4px 15px rgba(59, 76, 202, 0.3);
        }

        #team-pokemon-selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            overflow-y: auto; /* This will scroll */
            padding: 15px;
            background: rgba(248, 250, 252, 0.5);
            border-radius: 15px;
            border: 1px solid rgba(59, 76, 202, 0.1);
            flex-grow: 1;
        }

        .selector-card {
            border: 2px solid rgba(226, 232, 240, 0.8);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
        }

        .selector-card:hover {
            border-color: var(--secondary-color);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .selector-card.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(59, 76, 202, 0.1) 0%, rgba(255, 222, 0, 0.1) 100%);
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(59, 76, 202, 0.3);
        }

        .selector-card span {
            font-size: 1rem;
            font-weight: 700;
            color: var(--dark-color);
        }

        .team-preview-slots {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .preview-slot {
            height: 90px;
            background: rgba(255,255,255,0.8);
            border: 2px dashed rgba(203, 213, 225, 0.8);
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            font-weight: 700;
            font-size: 0.9rem;
            padding: 10px;
            text-align: center;
            overflow: hidden;
            transition: var(--transition);
        }

        .preview-slot.filled {
            border-style: solid;
            border-color: var(--primary-color);
            background: rgba(255,255,255,0.95);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .preview-slot .pokemon-type {
            font-size: 0.7rem;
            padding: 3px 8px;
            margin-top: 5px;
        }

        /* --- Create Team Button --- */
        #create-team-btn, #start-building-btn {
            background: var(--accent-color);
            background: linear-gradient(135deg, var(--accent-color) 0%, #dc2626 100%);
            color: #fff;
            margin-top: 15px;
            font-size: 1.1rem;
            padding: 15px 30px;
            box-shadow: 0 8px 20px rgba(204, 0, 0, 0.3);
        }

        #create-team-btn:hover, #start-building-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(204, 0, 0, 0.4);
        }

        #preview-toggle-btn {
            display: none; /* Hidden by default */
            width: fit-content;
            margin: 0 auto 15px;
            background: var(--secondary-color);
            color: var(--dark-color);
            font-weight: 900;
        }


        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .navbar .container { 
                flex-direction: column;
                gap: 15px;
            }
            
            .navbar .nav-links { 
                flex-wrap: wrap;
                justify-content: center;
            }
            
            #landing-page h1 { 
                font-size: 2.5rem; 
            }
            
            .catchphrase {
                font-size: 1.8rem;
            }
            
            #landing-page p { 
                font-size: 1.3rem; 
            }
            
            .page-header h2 {
                font-size: 2.2rem;
            }
            
            .grid-container {
                grid-template-columns: 1fr;
            }
            
            .team-builder-layout { 
                flex-direction: column;
            }
            
            #team-pokemon-selector-grid { 
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
            }
            
            .team-preview-slots {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 8px;
            }
            
            .preview-slot {
                height: 70px;
                font-size: 0.8rem;
            }
            
            .selector-card {
                padding: 10px;
            }
            
            .selector-card span {
                font-size: 0.9rem;
            }

            #preview-toggle-btn {
                display: block; /* Show on mobile */
            }

            .team-preview-panel.hidden-mobile {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 15px;
            }
            
            .navbar .logo {
                font-size: 1.5rem;
            }
            
            #landing-page {
                padding: 60px 15px;
            }
            
            #landing-page h1 {
                font-size: 2rem;
            }
            
            .catchphrase {
                font-size: 1.5rem;
            }
            
            .team-preview-slots {
                grid-template-columns: 1fr 1fr;
                gap: 5px;
            }
            
            .preview-slot {
                height: 60px;
                font-size: 0.7rem;
            }
            
            .card-header {
                padding: 20px 15px;
            }
            
            .card-body {
                padding: 0 15px 20px;
            }
        }

    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container">
            <div class="logo">PokéBuilder</div>
            <div class="nav-links">
                <a href="#pokedex" id="nav-pokedex">Pokédex</a>
                <a href="#teams" id="nav-teams">My Teams</a>
                <button id="auth-btn">Login / Signup</button>
            </div>
        </div>
    </nav>

    <main class="container">

        <section id="landing-page" class="page active">
            <h1>Welcome, Pokémon Trainer!</h1>
            <div class="catchphrase">Gotta Catch 'Em All!</div>
            <p>Build your ultimate team and prepare for battle.</p>
            <button id="start-building-btn">Start Building Your Team</button>
        </section>

        <section id="pokedex-page" class="page">
            <div class="page-header">
                <h2>The Pokédex</h2>
                <input type="text" id="pokedex-search" class="search-bar" placeholder="Search for a Pokémon...">
            </div>
            <div id="pokedex-grid" class="grid-container">
                <!-- Pokémon cards will be injected here -->
            </div>
        </section>

        <section id="teams-page" class="page">
            <div class="page-header">
                <h2>My Teams</h2>
                <button id="create-team-btn">Create New Team</button>
            </div>
            <div id="teams-grid" class="grid-container">
                <!-- Team cards will be injected here -->
            </div>
        </section>
    </main>

    <!-- Authentication Modal -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <form id="login-form" class="modal-form">
                <h2>Login</h2>
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit">Login</button>
                <p class="form-toggle">Don't have an account? <a id="show-signup">Sign up</a></p>
            </form>
            <form id="signup-form" class="modal-form" style="display:none;">
                <h2>Sign Up</h2>
                <input type="email" name="email" placeholder="Email" required>
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit">Sign Up</button>
                <p class="form-toggle">Already have an account? <a id="show-login">Login</a></p>
            </form>
        </div>
    </div>

    <!-- Team Creation/Edit Modal -->
    <div id="team-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <form id="team-form" class="modal-form">
                <h2 id="team-modal-title">Create Team</h2>
                <input type="hidden" id="team-id-input">
                <input type="text" id="team-name-input" placeholder="Team Name" required>
                
                <button type="button" id="preview-toggle-btn">Hide Preview</button>

                <div class="team-builder-layout">
                    <div class="pokemon-selection-panel">
                        <div class="selector-controls">
                            <input type="text" id="selector-search" class="search-bar" placeholder="Search Pokémon...">
                            <div id="selector-type-filters" class="type-filters">
                                <!-- Type filter buttons will be injected here -->
                            </div>
                        </div>
                        <div id="team-pokemon-selector-grid">
                            <!-- Selectable Pokémon cards will be injected here -->
                        </div>
                    </div>

                    <div class="team-preview-panel">
                        <h3>Team Preview</h3>
                        <div id="team-preview-slots" class="team-preview-slots">
                            <!-- 6 preview slots will be generated here -->
                        </div>
                    </div>
                </div>

                <button type="submit">Save Team</button>
            </form>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- GLOBAL STATE & CONFIG ---
    const API_BASE_URL = ''; // Use relative path
    let authToken = localStorage.getItem('pokemonToken');
    let allPokemons = [];
    let selectedPokemonForTeam = [];

    // --- DOM ELEMENT SELECTORS ---
    const pages = document.querySelectorAll('.page');
    const navPokedex = document.getElementById('nav-pokedex');
    const navTeams = document.getElementById('nav-teams');
    const authBtn = document.getElementById('auth-btn');
    const logo = document.querySelector('.logo');
    const startBuildingBtn = document.getElementById('start-building-btn');
    const pokedexGrid = document.getElementById('pokedex-grid');
    const pokedexSearch = document.getElementById('pokedex-search');
    const teamsGrid = document.getElementById('teams-grid');
    const createTeamBtn = document.getElementById('create-team-btn');

    // Modals
    const authModal = document.getElementById('auth-modal');
    const teamModal = document.getElementById('team-modal');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const teamForm = document.getElementById('team-form');
    
    // New Team Modal Elements
    const teamPokemonSelectorGrid = document.getElementById('team-pokemon-selector-grid');
    const selectorSearch = document.getElementById('selector-search');
    const selectorTypeFilters = document.getElementById('selector-type-filters');
    const teamPreviewSlots = document.getElementById('team-preview-slots');
    const previewToggleBtn = document.getElementById('preview-toggle-btn');
    const teamPreviewPanel = document.querySelector('.team-preview-panel');


    // --- API HELPER FUNCTIONS ---
    const apiFetch = async (endpoint, options = {}) => {
        options.headers = { ...options.headers, 'Content-Type': 'application/json' };
        if (authToken) {
            options.headers['Authorization'] = `Bearer ${authToken}`;
        }
        const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
        if (!response.ok) {
            const errorData = await response.json();
            alert(`Error: ${errorData.detail || 'Something went wrong'}`);
            throw new Error(errorData.detail);
        }
        return response.status !== 204 ? response.json() : null;
    };

    // --- UI RENDERING ---
    const showPage = (pageId) => {
        pages.forEach(page => page.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
    };

    const updateUIForAuthState = () => {
        if (authToken) {
            authBtn.textContent = 'Logout';
        } else {
            authBtn.textContent = 'Login / Signup';
            showPage('landing-page');
        }
    };

    const renderPokedex = (pokemons) => {
        pokedexGrid.innerHTML = pokemons.map(p => `
            <div class="card">
                <div class="card-header">
                    <h3>#${p.id} ${p.name}</h3>
                    <div>
                        <span class="pokemon-type" style="background-color: ${getTypeColor(p.type1)};">${p.type1}</span>
                        ${p.type2 ? `<span class="pokemon-type" style="background-color: ${getTypeColor(p.type2)};">${p.type2}</span>` : ''}
                    </div>
                </div>
                <div class="card-body">
                    <p><strong>HP:</strong> <span>${p.HP}</span></p>
                    <p><strong>Attack:</strong> <span>${p.Attack}</span></p>
                    <p><strong>Defense:</strong> <span>${p.Defense}</span></p>
                </div>
            </div>
        `).join('');
    };
    
    const renderTeams = (teams) => {
        if (teams.length === 0) {
            teamsGrid.innerHTML = `<p style="text-align: center; font-size: 1.2rem;">You haven't created any teams yet! Click "Create New Team" to start.</p>`;
            return;
        }
        teamsGrid.innerHTML = teams.map(team => `
            <div class="card team-card" data-team-id="${team.id}">
                <div class="card-header">
                    <h3>${team.name}</h3>
                </div>
                <div class="team-preview">
                    ${team.pokemons.slice(0, 6).map(p => `<div class="team-preview-pokemon" title="${p.name}">${p.name.substring(0,2).toUpperCase()}</div>`).join('')}
                    ${team.pokemons.length > 6 ? `<div class="team-preview-pokemon">...</div>` : ''}
                </div>
                <div class="team-pokemons-list">
                    <h4>Pokémon:</h4>
                    ${team.pokemons.map(p => `<p>• ${p.name}</p>`).join('')}
                </div>
                <div class="card-footer">
                    <button class="edit-team-btn" data-team-id="${team.id}">Edit</button>
                    <button class="delete-team-btn delete" data-team-id="${team.id}">Delete</button>
                </div>
            </div>
        `).join('');
    };

    // --- INITIALIZATION & EVENT LISTENERS ---
    const init = async () => {
        updateUIForAuthState();
        try {
            allPokemons = await apiFetch('/pokemon/');
            renderPokedex(allPokemons);
            populateTypeFilters();
        } catch (error) {
            console.error("Could not fetch Pokémon:", error);
            pokedexGrid.innerHTML = "<p>Could not load Pokédex. Is the API server running?</p>";
        }
    };

    // Navigation and Auth
    logo.addEventListener('click', () => showPage('landing-page'));
    navPokedex.addEventListener('click', (e) => { e.preventDefault(); showPage('pokedex-page'); });
    
    const handleTeamsNavigation = async (e) => {
        e.preventDefault();
        if (authToken) {
            try {
                const teams = await apiFetch('/teams/');
                renderTeams(teams);
                showPage('teams-page');
            } catch (error) { console.error('Failed to fetch teams:', error); }
        } else {
            loginForm.style.display = 'block';
            signupForm.style.display = 'none';
            authModal.classList.add('active');
        }
    };

    navTeams.addEventListener('click', handleTeamsNavigation);
    startBuildingBtn.addEventListener('click', handleTeamsNavigation);

    authBtn.addEventListener('click', () => {
        if (authToken) {
            authToken = null;
            localStorage.removeItem('pokemonToken');
            updateUIForAuthState();
        } else {
            loginForm.style.display = 'block';
            signupForm.style.display = 'none';
            authModal.classList.add('active');
        }
    });
    document.getElementById('show-signup').addEventListener('click', () => { loginForm.style.display = 'none'; signupForm.style.display = 'block'; });
    document.getElementById('show-login').addEventListener('click', () => { signupForm.style.display = 'none'; loginForm.style.display = 'block'; });
    
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new URLSearchParams();
        formData.append('username', e.target.username.value);
        formData.append('password', e.target.password.value);
        try {
            const response = await fetch(`${API_BASE_URL}/login`, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: formData });
            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.detail || 'Login failed');
            }
            const data = await response.json();
            authToken = data.access_token;
            localStorage.setItem('pokemonToken', authToken);
            updateUIForAuthState();
            authModal.classList.remove('active');
            navTeams.click(); // Go to teams page after successful login
        } catch (error) { alert(error.message); }
    });

    signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userData = { email: e.target.email.value, username: e.target.username.value, password: e.target.password.value };
        try {
            await apiFetch('/create_user', { method: 'POST', body: JSON.stringify(userData) });
            alert('Signup successful! Please log in.');
            document.getElementById('show-login').click();
        } catch (error) { console.error('Signup failed:', error); }
    });

    pokedexSearch.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredPokemons = allPokemons.filter(p => p.name.toLowerCase().includes(searchTerm));
        renderPokedex(filteredPokemons);
    });

    // --- TEAM MANAGEMENT LOGIC ---
    const openTeamModal = (team = null) => {
        teamForm.reset();
        selectorSearch.value = '';
        document.getElementById('team-id-input').value = team ? team.id : '';
        document.getElementById('team-modal-title').textContent = team ? 'Edit Team' : 'Create Team';
        document.getElementById('team-name-input').value = team ? team.name : '';
        
        selectedPokemonForTeam = team ? team.pokemons.map(p => p.id) : [];
        
        // Reset preview visibility for mobile
        teamPreviewPanel.classList.remove('hidden-mobile');
        previewToggleBtn.textContent = 'Hide Preview';

        applySelectorFilters();
        updateTeamPreview();
        teamModal.classList.add('active');
    };
    
    const applySelectorFilters = () => {
        const searchTerm = selectorSearch.value.toLowerCase();
        const activeTypeFilter = document.querySelector('#selector-type-filters button.active');
        const type = activeTypeFilter ? activeTypeFilter.dataset.type : null;

        const filteredPokemons = allPokemons.filter(p => {
            const nameMatch = p.name.toLowerCase().includes(searchTerm);
            const typeMatch = !type || p.type1.toLowerCase() === type || (p.type2 && p.type2.toLowerCase() === type);
            return nameMatch && typeMatch;
        });
        renderSelectorGrid(filteredPokemons);
    };

    const renderSelectorGrid = (pokemons) => {
        teamPokemonSelectorGrid.innerHTML = pokemons.map(p => `
            <div class="selector-card ${selectedPokemonForTeam.includes(p.id) ? 'selected' : ''}" data-pokemon-id="${p.id}">
                <span>${p.name}</span>
            </div>
        `).join('');
    };

    const updateTeamPreview = () => {
        teamPreviewSlots.innerHTML = '';
        for (let i = 0; i < 6; i++) {
            const pokemonId = selectedPokemonForTeam[i];
            if (pokemonId) {
                const pokemon = allPokemons.find(p => p.id === pokemonId);
                teamPreviewSlots.innerHTML += `
                    <div class="preview-slot filled" style="border-color: ${getTypeColor(pokemon.type1)};">
                        ${pokemon.name}
                        <span class="pokemon-type" style="background-color: ${getTypeColor(pokemon.type1)};">${pokemon.type1}</span>
                    </div>`;
            } else {
                teamPreviewSlots.innerHTML += `<div class="preview-slot">Slot ${i + 1}</div>`;
            }
        }
    };
    
    // Event Listeners for Team Modal
    createTeamBtn.addEventListener('click', () => openTeamModal());
    selectorSearch.addEventListener('input', applySelectorFilters);
    selectorTypeFilters.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const currentActive = document.querySelector('#selector-type-filters button.active');
            if (currentActive) {
                currentActive.classList.remove('active');
            }
            if (currentActive !== e.target) {
                 e.target.classList.add('active');
            }
            applySelectorFilters();
        }
    });

    previewToggleBtn.addEventListener('click', () => {
        teamPreviewPanel.classList.toggle('hidden-mobile');
        if (teamPreviewPanel.classList.contains('hidden-mobile')) {
            previewToggleBtn.textContent = 'Show Preview';
        } else {
            previewToggleBtn.textContent = 'Hide Preview';
        }
    });

    teamPokemonSelectorGrid.addEventListener('click', (e) => {
        const card = e.target.closest('.selector-card');
        if (!card) return;

        const pokemonId = parseInt(card.dataset.pokemonId);
        const index = selectedPokemonForTeam.indexOf(pokemonId);

        if (index > -1) {
            selectedPokemonForTeam.splice(index, 1);
            card.classList.remove('selected');
        } else {
            if (selectedPokemonForTeam.length >= 6) {
                alert('A team can have a maximum of 6 Pokémon.');
                return;
            }
            selectedPokemonForTeam.push(pokemonId);
            card.classList.add('selected');
        }
        updateTeamPreview();
    });

    teamsGrid.addEventListener('click', async (e) => {
        const teamCard = e.target.closest('.team-card');
        if (!teamCard) return;

        if (!e.target.closest('button')) {
            teamCard.querySelector('.team-pokemons-list').classList.toggle('expanded');
        }

        if (e.target.classList.contains('edit-team-btn')) {
            const teamId = e.target.dataset.teamId;
            const teams = await apiFetch('/teams/');
            const team = teams.find(t => t.id == teamId);
            openTeamModal(team);
        }

        if (e.target.classList.contains('delete-team-btn')) {
            if (!confirm('Are you sure you want to delete this team?')) return;
            const teamId = e.target.dataset.teamId;
            try {
                await apiFetch(`/teams/${teamId}`, { method: 'DELETE' });
                navTeams.click();
            } catch (error) { console.error('Failed to delete team:', error); }
        }
    });

    teamForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const teamId = document.getElementById('team-id-input').value;
        const teamData = {
            name: document.getElementById('team-name-input').value,
            pokemon_ids: selectedPokemonForTeam
        };

        try {
            if (teamId) {
                await apiFetch(`/teams/${teamId}`, { method: 'PUT', body: JSON.stringify(teamData) });
            } else {
                await apiFetch('/teams/', { method: 'POST', body: JSON.stringify(teamData) });
            }
            teamModal.classList.remove('active');
            navTeams.click();
        } catch (error) { console.error('Failed to save team:', error); }
    });

    // Modal Closing Logic
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', () => {
            btn.closest('.modal').classList.remove('active');
        });
    });
    
    // --- UTILITY FUNCTIONS ---
    const populateTypeFilters = () => {
        if (!allPokemons || allPokemons.length === 0) return;
        const types = [...new Set(allPokemons.flatMap(p => [p.type1, p.type2]).filter(Boolean))].sort();
        selectorTypeFilters.innerHTML = types.map(type => `<button data-type="${type.toLowerCase()}">${type}</button>`).join('');
    };

    const getTypeColor = (type) => {
        const colors = {
            grass: '#78C850', poison: '#A040A0', fire: '#F08030', flying: '#A890F0',
            water: '#6890F0', bug: '#A8B820', normal: '#A8A878', electric: '#F8D030',
            ground: '#E0C068', fairy: '#EE99AC', fighting: '#C03028', psychic: '#F85888',
            rock: '#B8A038', steel: '#B8B8D0', ice: '#98D8D8', ghost: '#705898', dragon: '#7038F8',
            dark: '#705848', shadow: '#493963'
        };
        return type ? colors[type.toLowerCase()] || '#68A090' : '#68A090';
    };

    // --- LET'S GO! ---
    init();
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Teams - Pokémon Team Builder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Fredoka+One:wght@400&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3B4CCA;
            --primary-gradient: linear-gradient(135deg, #3B4CCA 0%, #5A6EF0 100%);
            --secondary-color: #FFDE00;
            --accent-color: #CC0000;
            --light-color: #f8fafc;
            --dark-color: #1e293b;
            --font-family: 'Nunito', sans-serif;
            --cartoon-font: 'Fredoka One', cursive;
            --card-shadow: 0 10px 25px rgba(59, 76, 202, 0.1);
            --border-radius: 20px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background: linear-gradient(135deg, var(--light-color) 0%, #e2e8f0 100%); }
        .container { max-width: 1200px; margin: auto; padding: 0 20px; }
        button { font-family: var(--font-family); font-weight: 700; border: none; padding: 12px 24px; border-radius: var(--border-radius); cursor: pointer; }
        .navbar { background: var(--primary-gradient); color: #fff; padding: 1rem 0; position: sticky; top: 0; z-index: 1000; box-shadow: var(--card-shadow); }
        .navbar .container { display: flex; justify-content: space-between; align-items: center; }
        .navbar .logo { font-family: var(--cartoon-font); font-size: 2rem; color: var(--secondary-color); text-shadow: 3px 3px 6px rgba(0,0,0,0.3); text-decoration: none; }
        .navbar .nav-links { display: flex; align-items: center; gap: 10px; }
        .navbar .nav-links a { color: #fff; padding: 10px 20px; text-decoration: none; font-weight: 700; background: rgba(255,255,255,0.1); border-radius: 25px; font-size: 1rem; }
        .hamburger { display: none; cursor: pointer; }
        .hamburger .bar { display: block; width: 25px; height: 3px; margin: 5px auto; transition: all 0.3s ease-in-out; background-color: white; }
        main { padding: 40px 0; }
        .page-header { text-align: center; margin-bottom: 40px; }
        .page-header h2 { font-family: var(--cartoon-font); font-size: 3rem; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 20px; }
        #create-team-btn { background: var(--accent-color); color: #fff; font-size: 1.1rem; padding: 15px 30px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        .card { background: rgba(255,255,255,0.9); border-radius: var(--border-radius); box-shadow: var(--card-shadow); overflow: hidden; transition: all 0.3s ease; cursor: pointer; }
        .card:hover { transform: translateY(-5px); }
        .card-header { padding: 25px; text-align: center; }
        .card-header h3 { margin: 0; font-size: 1.6rem; font-weight: 900; }
        .team-preview { display: flex; justify-content: center; gap: 8px; padding: 15px; flex-wrap: wrap; }
        .team-preview-pokemon { width: 50px; height: 50px; background: #e2e8f0; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        .team-preview-pokemon img { width: 100%; height: 100%; image-rendering: pixelated; }
        .team-pokemons-list { display: none; padding: 25px; background: #f8fafc; }
        .team-pokemons-list.expanded { display: block; }
        .team-pokemons-list p { display: flex; align-items: center; gap: 10px; font-size: 1.1rem; text-transform: capitalize; }
        .team-pokemons-list img { width: 40px; height: 40px; image-rendering: pixelated; }
        .card-footer { display: flex; justify-content: space-around; background: #f1f5f9; padding: 15px; gap: 10px; cursor: default; }
        .card-footer button { flex: 1; background: var(--primary-gradient); color: #fff; border-radius: 15px; }
        .card-footer button.delete { background: var(--accent-color); }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; padding: 10px; }
        .modal.active { display: flex; }
        .modal-content { background: #fff; padding: 20px; border-radius: var(--border-radius); width: 100%; max-width: 900px; position: relative; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-close { position: absolute; top: 10px; right: 10px; font-size: 1.5rem; cursor: pointer; border: none; background: none; z-index: 10; }
        .modal-form { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        .modal-form h2 { text-align: center; margin-bottom: 20px; font-family: var(--cartoon-font); font-size: 1.8rem; color: var(--primary-color); }
        .modal-form input[type="text"] { width: 100%; padding: 12px 15px; margin-bottom: 15px; border: 2px solid #ccc; border-radius: 15px; font-size: 1rem; }
        .modal-form button[type="submit"] { width: 100%; background: var(--primary-gradient); color: #fff; margin-top: 15px; padding: 15px; font-size: 1.1rem; flex-shrink: 0; }
        .team-builder-layout { display: flex; gap: 20px; margin-top: 15px; flex-grow: 1; overflow: hidden; }
        .pokemon-selection-panel { flex: 2; display: flex; flex-direction: column; overflow: hidden; }
        .team-preview-panel { flex: 1; background: #f8fafc; border-radius: 15px; padding: 15px; }
        .team-preview-panel h3 { font-family: var(--cartoon-font); color: var(--primary-color); margin-bottom: 15px; text-align: center; font-size: 1.2rem; }
        .selector-controls { margin-bottom: 15px; flex-shrink: 0; }
        .selector-controls .search-bar { width: 100%; padding: 12px 15px; font-size: 1rem; border-radius: 15px; margin: 0; }
        .type-filters { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .type-filters button { padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; background: #e2e8f0; }
        .type-filters button.active { background: var(--primary-gradient); color: #fff; }
        #team-pokemon-selector-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; overflow-y: auto; padding: 15px; background: #f8fafc; border-radius: 15px; flex-grow: 1; }
        .selector-card { border: 2px solid #eee; border-radius: 15px; padding: 10px; text-align: center; cursor: pointer; background: #fff; }
        .selector-card.selected { border-color: var(--primary-color); background: #e7f0ff; }
        .selector-card img { width: 60px; height: 60px; image-rendering: pixelated; }
        .selector-card span { font-size: 0.9rem; font-weight: 700; display: block; margin-top: 5px; text-transform: capitalize; }
        .team-preview-slots { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .preview-slot { height: 90px; background: #fff; border: 2px dashed #ccc; border-radius: 15px; display: flex; justify-content: center; align-items: center; flex-direction: column; font-weight: 700; font-size: 0.9rem; padding: 10px; }
        .preview-slot.filled { border-style: solid; border-color: var(--primary-color); }
        .preview-slot img { width: 50px; height: 50px; image-rendering: pixelated; }
        #team-modal-tabs { display: none; }
        
        @media (max-width: 768px) {
            .navbar .nav-links { position: fixed; left: -100%; top: 70px; gap: 0; flex-direction: column; background-color: var(--primary-color); width: 100%; text-align: center; transition: 0.3s; padding-bottom: 20px; box-shadow: 0 10px 10px rgba(0,0,0,0.1); }
            .navbar .nav-links.active { left: 0; }
            .navbar .nav-links a { margin: 16px 0; }
            .hamburger { display: block; }
            .hamburger.active .bar:nth-child(2) { opacity: 0; }
            .hamburger.active .bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
            .hamburger.active .bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }
            .grid-container { grid-template-columns: 1fr; }
            .page-header h2 { font-size: 2.5rem; }
            #team-modal-tabs { display: grid; width: 100%; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
            #team-modal-tabs button { width: 100%; background: #e2e8f0; color: var(--dark-color); }
            #team-modal-tabs button.active { background: var(--primary-gradient); color: #fff; }
            .team-builder-layout { flex-direction: column; }
            .team-preview-panel { display: none; } 
            .team-builder-layout.review-mode .pokemon-selection-panel { display: none; }
            .team-builder-layout.review-mode .team-preview-panel { display: flex; flex-direction: column; }
            .team-preview-slots { grid-template-columns: 1fr 1fr 1fr; }
        }
        @media (max-width: 480px) {
            .navbar .logo { font-size: 1.8rem; }
            .page-header h2 { font-size: 2.2rem; }
            .team-preview-slots { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container">
            <a href="/" class="logo">PokéBuilder</a>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
            <div class="nav-links">
                <a href="/pokedex.html">Pokédex</a>
                <a href="/teams.html" id="nav-teams">My Teams</a>
                <a href="/safari.html">Catch Pokémon</a>
                <a href="/shop.html">Shop</a>
                <a href="/battle.html">PokéStreak</a>
                <a href="/auth.html" id="auth-btn">Login / Signup</a>
            </div>
        </div>
    </nav>

    <main class="container">
        <section id="teams-page">
            <div class="page-header">
                <h2>My Teams</h2>
                <button id="create-team-btn">Create New Team</button>
            </div>
            <div id="teams-grid" class="grid-container"></div>
        </section>
    </main>

    <div id="team-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <form id="team-form" class="modal-form">
                <h2 id="team-modal-title">Create Team</h2>
                <input type="hidden" id="team-id-input">
                <input type="text" id="team-name-input" placeholder="Team Name" required>
                
                <div id="team-modal-tabs">
                    <button type="button" id="tab-select" class="active">Select Pokémon</button>
                    <button type="button" id="tab-review">Review Team (0/6)</button>
                </div>

                <div class="team-builder-layout">
                    <div class="pokemon-selection-panel view-active">
                        <div class="selector-controls">
                            <input type="text" id="selector-search" class="search-bar" placeholder="Search Pokémon...">
                            <div id="selector-type-filters" class="type-filters"></div>
                        </div>
                        <div id="team-pokemon-selector-grid"></div>
                    </div>
                    <div class="team-preview-panel">
                        <h3>Team Preview</h3>
                        <div id="team-preview-slots" class="team-preview-slots"></div>
                    </div>
                </div>
                <button type="submit">Save Team</button>
            </form>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const hamburger = document.querySelector('.hamburger');
    const navLinks = document.querySelector('.nav-links');

    hamburger.addEventListener('click', () => {
        hamburger.classList.toggle('active');
        navLinks.classList.toggle('active');
    });
    
    const authToken = localStorage.getItem('pokemonToken');
    if (!authToken) {
        window.location.href = `/auth.html?redirect=${window.location.pathname}`;
        return;
    }

    const authBtn = document.getElementById('auth-btn');
    authBtn.textContent = 'Logout';
    authBtn.href = "#";
    authBtn.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('pokemonToken');
        window.location.href = '/auth.html';
    });

    let allPokemons = []; // The original full list from API
    let standardPokemons = []; // The clean list with new IDs
    let selectedPokemonForTeam = []; // Holds ORIGINAL IDs for the backend
    const teamsGrid = document.getElementById('teams-grid');
    const createTeamBtn = document.getElementById('create-team-btn');
    const teamModal = document.getElementById('team-modal');
    const teamForm = document.getElementById('team-form');
    const teamPokemonSelectorGrid = document.getElementById('team-pokemon-selector-grid');
    const selectorSearch = document.getElementById('selector-search');
    const selectorTypeFilters = document.getElementById('selector-type-filters');
    const teamPreviewSlots = document.getElementById('team-preview-slots');
    
    const tabSelect = document.getElementById('tab-select');
    const tabReview = document.getElementById('tab-review');
    const pokemonSelectionPanel = document.querySelector('.pokemon-selection-panel');
    const teamPreviewPanel = document.querySelector('.team-preview-panel');

    const apiFetch = async (endpoint, options = {}) => {
        options.headers = { ...options.headers, 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` };
        const response = await fetch(endpoint, options);
        if (response.status === 401) {
            localStorage.removeItem('pokemonToken');
            window.location.href = `/auth.html?redirect=${window.location.pathname}`;
            return;
        }
        if (!response.ok) {
            const errorData = await response.json();
            alert(`Error: ${errorData.detail || 'Something went wrong'}`);
            throw new Error(errorData.detail);
        }
        return response.status !== 204 ? response.json() : null;
    };

    const getTypeColor = (type) => {
        const colors = {
            grass: '#78C850', poison: '#A040A0', fire: '#F08030', flying: '#A890F0',
            water: '#6890F0', bug: '#A8B820', normal: '#A8A878', electric: '#F8D030',
            ground: '#E0C068', fairy: '#EE99AC', fighting: '#C03028', psychic: '#F85888',
            rock: '#B8A038', steel: '#B8B8D0', ice: '#98D8D8', ghost: '#705898', dragon: '#7038F8',
            dark: '#705848', shadow: '#493963'
        };
        return type ? colors[type.toLowerCase()] || '#68A090' : '#68A090';
    };

    const getSpriteUrl = (pokemon) => {
        // Find the re-assigned pokemon from our clean list to get the correct sequential ID for the sprite
        const displayPokemon = standardPokemons.find(p => p.original_id === pokemon.id);
        const spriteId = displayPokemon ? displayPokemon.id : pokemon.id;
        return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${spriteId}.png`;
    };

    const renderTeams = (teams) => {
        if (!teams || teams.length === 0) {
            teamsGrid.innerHTML = `<p style="text-align: center; font-size: 1.2rem;">You haven't created any teams yet! Click "Create New Team" to start.</p>`;
            return;
        }
        teamsGrid.innerHTML = teams.map(team => {
            // For each pokemon in a team, find its corresponding entry in our clean 'standardPokemons' list to get the correct sprite ID
            const teamPokemonsWithSprites = team.pokemons.map(p => {
                const displayInfo = standardPokemons.find(sp => sp.original_id === p.id);
                return { ...p, spriteId: displayInfo ? displayInfo.id : p.id };
            });

            return `
            <div class="card team-card" data-team-id="${team.id}">
                <div class="card-header"><h3>${team.name}</h3></div>
                <div class="team-preview">
                    ${teamPokemonsWithSprites.slice(0, 6).map(p => `<div class="team-preview-pokemon" title="${p.name}"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${p.spriteId}.png" alt="${p.name}"></div>`).join('')}
                </div>
                <div class="team-pokemons-list">
                    <h4>Pokémon:</h4>
                    ${teamPokemonsWithSprites.map(p => `<p><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${p.spriteId}.png" alt="${p.name}"> ${p.name}</p>`).join('')}
                </div>
                <div class="card-footer">
                    <button class="edit-team-btn" data-team-id="${team.id}">Edit</button>
                    <button class="delete-team-btn delete" data-team-id="${team.id}">Delete</button>
                </div>
            </div>
        `}).join('');
    };
    
    const fetchAndRenderTeams = async () => {
        try {
            const teams = await apiFetch('/teams/');
            renderTeams(teams);
        } catch (error) { console.error('Failed to fetch teams:', error); }
    };

    const init = async () => {
        try {
            // First fetch ALL pokemon to create the re-indexed master list for sprites
            const data = await apiFetch('/pokemon/');
            let filtered = data.filter(p => p.name && !p.name.toLowerCase().includes('mega'));
            standardPokemons = filtered.map((p, index) => ({
                ...p,
                original_id: p.id,
                id: index + 1
            }));
            
            // Now, fetch the user's personal collection to use in the builder
            allPokemons = await apiFetch('/safari/collection');

            populateTypeFilters();
            fetchAndRenderTeams();
        } catch (error) { console.error("Could not fetch necessary Pokémon data:", error); }
    };

    createTeamBtn.addEventListener('click', () => openTeamModal());
    
    teamsGrid.addEventListener('click', async (e) => {
        const teamCard = e.target.closest('.team-card');
        if (!teamCard) return;

        const targetButton = e.target.closest('button');
        if (targetButton) {
            e.stopPropagation();
            if (targetButton.classList.contains('edit-team-btn')) {
                const teamId = targetButton.dataset.teamId;
                const teams = await apiFetch('/teams/');
                const team = teams.find(t => t.id == teamId);
                openTeamModal(team);
            }
            if (targetButton.classList.contains('delete-team-btn')) {
                if (!confirm('Are you sure you want to delete this team?')) return;
                const teamId = targetButton.dataset.teamId;
                await apiFetch(`/teams/${teamId}`, { method: 'DELETE' });
                fetchAndRenderTeams();
            }
        } else {
             teamCard.querySelector('.team-pokemons-list').classList.toggle('expanded');
        }
    });

    const openTeamModal = (team = null) => {
        teamForm.reset();
        selectorSearch.value = '';
        document.getElementById('team-id-input').value = team ? team.id : '';
        document.getElementById('team-modal-title').textContent = team ? 'Edit Team' : 'Create Team';
        document.getElementById('team-name-input').value = team ? team.name : '';
        selectedPokemonForTeam = team ? team.pokemons.map(p => p.id) : []; // Uses original IDs
        tabSelect.click();
        applySelectorFilters();
        updateTeamPreview();
        teamModal.classList.add('active');
    };
    
    const applySelectorFilters = () => {
        const searchTerm = selectorSearch.value.toLowerCase();
        const activeTypeFilter = document.querySelector('#selector-type-filters button.active');
        const type = activeTypeFilter ? activeTypeFilter.dataset.type : null;
        
        // Filter from the user's collection (allPokemons)
        const filteredPokemons = allPokemons.filter(p => {
            const nameMatch = p.name.toLowerCase().includes(searchTerm);
            const typeMatch = !type || p.type1.toLowerCase() === type || (p.type2 && p.type2.toLowerCase() === type);
            return nameMatch && typeMatch;
        });
        renderSelectorGrid(filteredPokemons);
    };

    const renderSelectorGrid = (pokemons) => {
        teamPokemonSelectorGrid.innerHTML = pokemons.map(p => `
            <div class="selector-card ${selectedPokemonForTeam.includes(p.id) ? 'selected' : ''}" data-pokemon-id="${p.id}">
                <img src="${getSpriteUrl(p)}" alt="${p.name}">
                <span>${p.name}</span>
            </div>
        `).join('');
    };

    const updateTeamPreview = () => {
        tabReview.textContent = `Review Team (${selectedPokemonForTeam.length}/6)`;
        teamPreviewSlots.innerHTML = '';
        for (let i = 0; i < 6; i++) {
            const originalId = selectedPokemonForTeam[i];
            if (originalId) {
                const pokemon = allPokemons.find(p => p.id === originalId);
                teamPreviewSlots.innerHTML += `
                    <div class="preview-slot filled" style="border-color: ${getTypeColor(pokemon.type1)};">
                        <img src="${getSpriteUrl(pokemon)}" alt="${pokemon.name}">
                        ${pokemon.name}
                    </div>`;
            } else {
                teamPreviewSlots.innerHTML += `<div class="preview-slot">Slot ${i + 1}</div>`;
            }
        }
    };
    
    selectorSearch.addEventListener('input', applySelectorFilters);
    selectorTypeFilters.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const currentActive = document.querySelector('#selector-type-filters button.active');
            if (currentActive) currentActive.classList.remove('active');
            if (currentActive !== e.target) e.target.classList.add('active');
            applySelectorFilters();
        }
    });

    tabSelect.addEventListener('click', () => {
        pokemonSelectionPanel.classList.add('view-active');
        teamPreviewPanel.classList.remove('view-active');
        tabSelect.classList.add('active');
        tabReview.classList.remove('active');
    });
    tabReview.addEventListener('click', () => {
        pokemonSelectionPanel.classList.remove('view-active');
        teamPreviewPanel.classList.add('view-active');
        tabReview.classList.add('active');
        tabSelect.classList.remove('active');
    });

    teamPokemonSelectorGrid.addEventListener('click', (e) => {
        const card = e.target.closest('.selector-card');
        if (!card) return;
        const pokemonId = parseInt(card.dataset.pokemonId); // This is the ORIGINAL ID
        const index = selectedPokemonForTeam.indexOf(pokemonId);
        if (index > -1) {
            selectedPokemonForTeam.splice(index, 1);
        } else {
            if (selectedPokemonForTeam.length >= 6) {
                alert('A team can have a maximum of 6 Pokémon.');
                return;
            }
            selectedPokemonForTeam.push(pokemonId);
        }
        card.classList.toggle('selected');
        updateTeamPreview();
    });

    teamForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const teamId = document.getElementById('team-id-input').value;
        const teamData = { name: document.getElementById('team-name-input').value, pokemon_ids: selectedPokemonForTeam };
        try {
            if (teamId) {
                await apiFetch(`/teams/${teamId}`, { method: 'PUT', body: JSON.stringify(teamData) });
            } else {
                await apiFetch('/teams/', { method: 'POST', body: JSON.stringify(teamData) });
            }
            teamModal.classList.remove('active');
            fetchAndRenderTeams();
        } catch (error) { console.error('Failed to save team:', error); }
    });

    document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', () => btn.closest('.modal').classList.remove('active')));
    
    const populateTypeFilters = () => {
        // Filters should be based on the types available in the user's collection
        if (!allPokemons || allPokemons.length === 0) return;
        const types = [...new Set(allPokemons.flatMap(p => [p.type1, p.type2]).filter(Boolean))].sort();
        selectorTypeFilters.innerHTML = types.map(type => `<button data-type="${type.toLowerCase()}">${type}</button>`).join('');
    };

    init();
});
</script>
</body>
</html>
